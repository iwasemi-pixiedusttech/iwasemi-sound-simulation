<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>iwasemi｜音問題 診断サービス（フォーム連携 & 事例連携版）</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{ color-scheme: light dark; }
    .badge{ display:inline-block; padding:.125rem .5rem; border-radius:.5rem; font-size:.75rem; border:1px solid rgba(16,185,129,.35);}
    .toast{ position:fixed; right:1rem; bottom:1rem; background:#0f172a; color:#fff; padding:.75rem 1rem; border-radius:.75rem; opacity:.96; z-index:100;}
    .toast.ok{ background:#065f46; } .toast.ng{ background:#7f1d1d; }

    /* === Fullscreen Tips Overlay === */
    .tips-overlay{position:fixed;inset:0;z-index:90;display:none;background:rgba(15,23,42,.96);color:#fff}
    .tips-body{max-width:42rem;margin:8vh auto;padding:1.5rem}
    .tips-card{background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.15);border-radius:1rem;padding:1rem}
    .tips-actions{display:flex;gap:.5rem;justify-content:flex-end;margin-top:1rem}
    .tips-btn{background:#10b981;color:#0b1b26;border-radius:.75rem;padding:.5rem .9rem}
    .tips-btn.gray{background:#e2e8f0;color:#0b1b26}

    /* case card */
    .case-img{width:100%;height:160px;object-fit:cover;border-radius:.75rem;background:#0b1220}
  </style>
</head>
<body class="bg-slate-50 text-slate-900 selection:bg-emerald-200/60 dark:bg-slate-900 dark:text-slate-50">
  <div class="max-w-6xl mx-auto p-4 md:p-8">
    <!-- HEADER -->
    <header class="flex items-center justify-between gap-4 mb-6">
      <div class="flex items-center gap-3">
        <div class="size-10 rounded-2xl bg-emerald-500/90 flex items-center justify-center text-white font-bold">i</div>
        <div>
          <h1 class="text-xl md:text-2xl font-bold">iwasemi™｜音問題 診断サービス</h1>
          <p class="text-sm text-slate-500 dark:text-slate-400">入力から残響・遮音の課題を解析し、最適解と概算を自動提示します。</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="themeToggle" class="px-3 py-2 rounded-xl border border-slate-300/60 dark:border-slate-700 text-sm"></button>
        <a href="#result" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">結果を見る</a>
      </div>
    </header>

    <!-- PROGRESS -->
    <div id="progress" class="w-full h-2 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden mb-6">
      <div id="progressBar" class="h-full w-[0%] bg-emerald-500 transition-all"></div>
    </div>

    <!-- ================= FORM ================= -->
    <form id="diagForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">

      <!-- 1) 顧客情報 -->
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">1) 顧客情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <label class="block">
            <span class="text-sm">企業名</span>
            <input name="company" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="株式会社○○" />
          </label>
          <label class="block">
            <span class="text-sm">業種</span>
            <select name="industry" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>IT</option><option>製造</option><option>金融</option><option>学校</option><option>医療</option>
              <option>官公庁</option><option>BPO/コール</option><option>商業</option><option>物流</option><option>その他</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">規模</span>
            <select name="size" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>〜100名</option><option>101–500</option><option>501–1000</option><option>1001–5000</option><option>5001〜</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">都道府県</span>
            <select name="pref" required class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="">選択してください</option>
              <option>北海道</option><option>青森県</option><option>岩手県</option><option>宮城県</option><option>秋田県</option><option>山形県</option><option>福島県</option>
              <option>茨城県</option><option>栃木県</option><option>群馬県</option><option>埼玉県</option><option>千葉県</option><option>東京都</option><option>神奈川県</option>
              <option>新潟県</option><option>富山県</option><option>石川県</option><option>福井県</option><option>山梨県</option><option>長野県</option>
              <option>岐阜県</option><option>静岡県</option><option>愛知県</option><option>三重県</option>
              <option>滋賀県</option><option>京都府</option><option>大阪府</option><option>兵庫県</option><option>奈良県</option><option>和歌山県</option>
              <option>鳥取県</option><option>島根県</option><option>岡山県</option><option>広島県</option><option>山口県</option>
              <option>徳島県</option><option>香川県</option><option>愛媛県</option><option>高知県</option>
              <option>福岡県</option><option>佐賀県</option><option>長崎県</option><option>熊本県</option><option>大分県</option><option>宮崎県</option><option>鹿児島県</option><option>沖縄県</option>
            </select>
          </label>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
          <label class="block md:col-span-2">
            <span class="text-sm">実施想定時期</span>
            <select name="timeline" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>今期</option><option>来期</option><option selected>未定</option>
            </select>
          </label>
        </div>
      </section>

      <!-- 1.5) 代理店担当者情報 -->
      <section class="md:col-span-2 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">1.5) 代理店担当者情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
          <label class="block">
            <span class="text-sm">企業名</span>
            <input name="agent_company" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="○○株式会社（代理店）" />
          </label>
          <label class="block">
            <span class="text-sm">担当者名</span>
            <input name="agent_person" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="山田 太郎" />
          </label>
          <label class="block">
            <span class="text-sm">支店名 / 部署</span>
            <input name="agentBranch" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="○○支店 / ○○営業部" />
          </label>
          <label class="block">
            <span class="text-sm">メールアドレス</span>
            <input name="agent_email" type="email" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" placeholder="taro@example.com" />
          </label>
        </div>
      </section>

      <!-- 2) 空間の基本情報 -->
      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">2) 空間の基本情報</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm">プロジェクト種別</span>
            <select name="project" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option>移転</option><option>改修</option><option selected>既存</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">空間カテゴリー</span>
            <select name="category" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="office">オフィス</option>
              <option value="nonoffice">オフィス以外（工場/学校/図書館/商業/スタジオ等）</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">空間タイプ</span>
            <select name="spaceType" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="meeting_closed">会議室（密閉）</option>
              <option value="meeting_transom">会議室（欄間オープン）</option>
              <option value="booth_tel">ワークブース（TELECUBE）</option>
              <option value="booth_built">ワークブース（造作）</option>
              <option value="open">オープンスペース（執務室）</option>
              <option value="reception">受付</option>
              <option value="callcenter">コールセンター</option>
              <option value="studio">スタジオ</option>
              <option value="other">その他</option>
            </select>
          </label>
          <div>
            <span class="text-sm block mb-1">利用用途（複数選択可）</span>
            <div class="grid grid-cols-1 gap-1">
              <!-- 会議 -->
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_multi" class="size-4">会議（複数人）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_1to1" class="size-4">会議（1対1/少人数）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_web" class="size-4">会議（Webメイン）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_f2f" class="size-4">会議（対面メイン）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="meeting_hybrid" class="size-4">会議（対面＋Web）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="exec" class="size-4">役員会議</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="internal" class="size-4">社内会議</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="external" class="size-4">社外会議</label>
              <!-- 個人作業/通話 -->
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="focus" class="size-4">集中作業</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="phone" class="size-4">電話（個人/顧客）</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="websolo" class="size-4">Web会議（1人）</label>
              <!-- クリエイティブ -->
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="music" class="size-4">音楽鑑賞</label>
              <label class="flex items-center gap-2"><input type="checkbox" name="use" value="stream" class="size-4">配信・収録</label>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <div>
            <span class="text-sm block mb-1">騒音源（複数選択可）</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="speech" class="size-4">人の声</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="machine" class="size-4">機械音</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="source" value="invasion_ext" class="size-4">外部からの音の侵入</label>
          </div>
          <label class="block">
            <span class="text-sm">従業員の声（うるささ）</span>
            <select name="complaint" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="low">低</option><option value="mid" selected>中</option><option value="high">高</option>
            </select>
          </label>
          <div>
            <span class="text-sm block mb-1">既存対策</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="partition" class="size-4">パーティション</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="absorption" class="size-4">吸音パネル</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="masking" class="size-4">サウンドマスキング</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="measure" value="none" class="size-4">特になし</label>
          </div>
        </div>
      </section>

      <!-- 3) 空間サイズ・構成要素 -->
      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">3) 空間サイズ・構成要素</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <label class="block">
            <span class="text-sm">床面積（㎡/室）</span>
            <input name="area" type="number" min="1" step="0.1" value="20" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" />
          </label>
          <label class="block">
            <span class="text-sm">室数（同仕様）</span>
            <input name="rooms" type="number" min="1" value="1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" />
          </label>
          <label class="block">
            <span class="text-sm">天井高</span>
            <select name="ceilHeight" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="lt2_5">2.5m未満</option>
              <option value="2_5_3_0" selected>2.5〜3.0m</option>
              <option value="3_0_3_5">3.0〜3.5m</option>
              <option value="gt3_5">3.5m以上</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <!-- 壁材（4面） -->
        <div class="mt-4">
          <span class="text-sm block mb-2">壁材（4面）</span>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <label class="block"><span class="text-xs text-slate-500">壁①</span>
              <select name="wall1" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁②</span>
              <select name="wall2" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁③</span>
              <select name="wall3" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
            <label class="block"><span class="text-xs text-slate-500">壁④</span>
              <select name="wall4" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
                <option value="gypsum">石膏ボード＋クロス</option>
                <option value="glass_s">ガラス（シングル）</option>
                <option value="glass_d">ガラス（ダブル）</option>
                <option value="rc">コンクリート打放し</option>
                <option value="abs_finish">吸音パネル仕上げ</option>
                <option value="wood">木質</option>
                <option value="steel_part">スチールパーティション</option>
                <option value="unknown">不明</option>
              </select>
            </label>
          </div>
        </div>

        <!-- 床・天井・扉・ガラス・その他 -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">床材</span>
            <select name="floor" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="carpet">タイルカーペット</option>
              <option value="wood">フローリング</option>
              <option value="pvc">塩ビシート（PVC）</option>
              <option value="tile_stone">タイル・石材</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">天井材</span>
            <select name="ceiling" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="pb">化粧石膏ボード</option>
              <option value="mineral_grid">岩綿吸音板（グリッド）</option>
              <option value="metal">金属パネル天井</option>
              <option value="exposed">露出天井（スケルトン）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">扉の種類</span>
            <select name="door" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="wood_solid">木製（単板）</option>
              <option value="wood_honeycomb">木製（中空ハニカム）</option>
              <option value="glass_s">ガラス（シングル）</option>
              <option value="glass_d">ガラス（ダブル）</option>
              <option value="steel">スチールドア</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">扉の隙間処理</span>
            <select name="doorSeal" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="gasket">ゴムパッキンあり（遮音）</option>
              <option value="bottom">ドアボトムシールあり</option>
              <option value="gap">隙間あり（標準）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">ガラスの種類</span>
            <select name="glazing" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="single">シングルガラス</option>
              <option value="double">ダブルガラス（ペア）</option>
              <option value="unknown">不明</option>
            </select>
          </label>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mt-4">
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="transom" class="size-4">欄間オープン</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="shared_plenum" class="size-4">共有天井裏（隣室と連続）</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="grille" class="size-4">ガラリ／換気開口あり</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_door_bottom" class="size-4">ドア下の隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_frame" class="size-4">枠まわりの隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_penetration" class="size-4">貫通部の隙間</label>
          <label class="flex items-center gap-2"><input type="checkbox" name="feature" value="gap_duct" class="size-4">ダクト等の隙間</label>
        </div>
      </section>

      <!-- 4) 期待する効果・制約 -->
      <section class="p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
        <h2 class="text-lg font-semibold mb-4">4) 期待する効果・制約</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <span class="text-sm block mb-1">直接効果（複数選択可）</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="clarity_meeting" class="size-4">会議の聞き取り</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="clarity_web" class="size-4">Web会議の聞き取り</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="speaking" class="size-4">話しやすさ</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="focus" class="size-4">集中力向上</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="leakage" class="size-4">音漏れの低減</label>
          </div>
          <div>
            <span class="text-sm block mb-1">業務・体験効果</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="productivity" class="size-4">生産性アップ</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="comfort" class="size-4">快適性・満足度</label>
          </div>
          <div>
            <span class="text-sm block mb-1">戦略的効果</span>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="brand" class="size-4">ブランド価値</label>
            <label class="flex items-center gap-2"><input type="checkbox" name="effect" value="innov" class="size-4">先進的オフィスイメージ</label>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
          <label class="block">
            <span class="text-sm">改修許容（施工可否）</span>
            <select name="work" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="night">夜間可</option><option value="weekend">週末のみ</option><option value="inhours">営業時間内のみ</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">完全遮音（音漏れゼロ）希望</span>
            <select name="zeroLeak" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent">
              <option value="no">いいえ</option><option value="yes">はい</option>
            </select>
          </label>
          <label class="block">
            <span class="text-sm">自己評価：現状の音環境（0=悪い〜10=良い）</span>
            <input name="selfScore" type="number" min="0" max="10" value="5" class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300/70 dark:border-slate-700 bg-transparent" />
          </label>
        </div>
      </section>

      <!-- 操作 -->
      <div class="md:col-span-2 flex flex-wrap gap-3 justify-end">
        <button type="button" id="resetBtn" class="px-4 py-2 rounded-xl border border-slate-300 dark:border-slate-700">リセット</button>
        <button type="button" id="diagnoseBtn" class="px-5 py-2.5 rounded-xl bg-emerald-600 text-white">診断する</button>
      </div>
    </form>

    <!-- ================= RESULT ================= -->
    <section id="result" class="mt-10 p-4 md:p-6 rounded-2xl bg-white dark:bg-slate-800 shadow-sm">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold">診断結果</h2>
        <div class="flex gap-2">
          <button id="downloadJson" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm">JSONダウンロード</button>
          <button id="printBtn" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm dark:bg-slate-100 dark:text-slate-900">印刷 / PDF</button>
        </div>
      </div>

      <!-- 0) 提案サマリー -->
      <div id="proposalSummary" class="mt-4"></div>

      <!-- 0.5) グローバルCTA -->
      <div id="globalCtas" class="mt-3 hidden"></div>

      <!-- 1) エビデンス -->
      <div id="evidenceWrap" class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4"></div>

      <!-- 1.5) 近い導入事例（通常用） -->
      <div id="caseWrap" class="mt-6"></div>

      <!-- 1.5') テレキューブ専用 事例写真（通常は hidden） -->
      <div id="boothCaseWrap" class="mt-6 hidden"></div>

      <!-- 2) 詳細レコメンド（最大3枚） -->
      <div id="recommendWrap" class="mt-6 grid grid-cols-1 lg:grid-cols-3 gap-4"></div>

      <!-- 3) iwasemi見積（詳細） -->
      <div id="iwasemiWrap" class="mt-6"></div>

      <!-- 備考 -->
      <div id="notesWrap" class="mt-6"></div>
    </section>

    <footer class="text-sm text-slate-500 dark:text-slate-400 mt-10">
      ©Pixie Dust Technologies Inc.
    </footer>
  </div>

  <div id="toast" class="hidden"></div>

  <!-- Tips Overlay -->
  <div id="tipsOverlay" class="tips-overlay" role="dialog" aria-modal="true" aria-label="注意事項">
    <div class="tips-body">
      <div class="tips-card">
        <h3 class="text-xl font-semibold mb-2">回り込み（フランキング）への注意</h3>
        <p class="text-sm opacity-90">
          欄間オープン／共有天井（プレナム共有）／ガラリ・換気開口は、隣室への<strong>音の回り込み経路</strong>となり、会話漏れやプライバシー低下の主因になります。
          上部のインフィル（塞ぎ）、開口のライニング・ダクト化、ドア・枠まわりの隙間封止などの<strong>経路対策</strong>をご検討ください。
        </p>
        <ul class="list-disc pl-5 mt-2 text-sm opacity-90">
          <li>欄間：上部インフィル（遮音ボード＋シーリング）</li>
          <li>共有天井：プレナム内が連続ならバリア設置</li>
          <li>ガラリ：ライニング（吸音）付きダクト／サウンドトラップ</li>
          <li>扉・枠：ガスケット、ドアボトムシールで隙間低減</li>
        </ul>
        <p class="text-xs mt-2 opacity-80">※ まず経路対策、その後に室内吸音で仕上げるのが定石です。</p>
        <div class="tips-actions">
          <button class="tips-btn gray" onclick="hideTips()">閉じる</button>
          <button class="tips-btn" onclick="hideTips()">了解</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== JSはこの下に続きます（2/3・3/3で提供） ===== -->
<script>
// ===============================================
// 基本ユーティリティ／テーマ／トースト／進捗バー
// ===============================================
const $ = (sel, el=document) => el.querySelector(sel);
const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

// THEME
const themeBtn = $('#themeToggle');
function setTheme(mode){
  if(mode==='dark'){
    document.documentElement.classList.add('dark');
    localStorage.setItem('theme','dark'); themeBtn.textContent='ライト';
  } else {
    document.documentElement.classList.remove('dark');
    localStorage.setItem('theme','light'); themeBtn.textContent='ダーク';
  }
}
themeBtn.addEventListener('click',()=> setTheme(document.documentElement.classList.contains('dark')?'light':'dark'));
setTheme(localStorage.getItem('theme')|| (window.matchMedia('(prefers-color-scheme: dark)').matches?'dark':'light'));

// TOAST
function toast(msg, ok=true){
  const t = $('#toast');
  t.className = 'toast ' + (ok?'ok':'ng');
  t.textContent = msg;
  t.classList.remove('hidden');
  setTimeout(()=> t.classList.add('hidden'), 3500);
}

// PROGRESS
const formEl = $('#diagForm');
const progressBar = $('#progressBar');
function updateProgress(){
  const required = $$('input[required], select[required]', formEl);
  const filled = required.filter(i=> i.value && i.value.trim()!=='' );
  const p = required.length ? Math.round((filled.length / required.length) * 100) : 100;
  progressBar.style.width = Math.min(100, Math.max(10,p)) + '%';
}
formEl.addEventListener('input', updateProgress);
updateProgress();

// Tips Overlay
function showTips(){ const el = $('#tipsOverlay'); if (el) el.style.display = 'block'; }
function hideTips(){ const el = $('#tipsOverlay'); if (el) el.style.display = 'none'; }

// UTIL
function getAllChecked(name){ return $$("input[name='"+name+"']:checked").map(i=>i.value); }
function yen(n){ return '¥' + (Math.round(n)||0).toLocaleString('ja-JP'); }
function fmt2(n){ return (Math.round(n*100)/100).toFixed(2); }

// ===============================================
// 入力収集（顧客情報／代理店担当者情報 分離対応）
// ===============================================
function collect(){
  const fd = new FormData(formEl);
  return {
    // 顧客情報
    company: fd.get('company')||'',
    industry: fd.get('industry')||'',
    size: fd.get('size')||'',
    pref: fd.get('pref')||'',
    timeline: fd.get('timeline')||'未定',

    // 代理店担当者情報
    agent_company: fd.get('agent_company')||'',
    agent_person : fd.get('agent_person')||'',
    agentBranch  : fd.get('agentBranch')||'',
    agent_email  : fd.get('agent_email')||'',

    // （旧 基本個人情報は廃止。以降は従来項目）
    // 空間
    project: fd.get('project')||'既存',
    category: fd.get('category')||'office',
    spaceType: fd.get('spaceType')||'meeting_closed',
    uses: getAllChecked('use'),
    sources: getAllChecked('source'),
    complaint: fd.get('complaint')||'mid',
    measures: getAllChecked('measure'),
    // 構成
    area: Number(fd.get('area')||0),
    rooms: Number(fd.get('rooms')||1),
    ceilHeight: fd.get('ceilHeight')||'2_5_3_0',
    walls: [
      fd.get('wall1')||'gypsum',
      fd.get('wall2')||'gypsum',
      fd.get('wall3')||'gypsum',
      fd.get('wall4')||'gypsum'
    ],
    floor: fd.get('floor')||'carpet',
    ceiling: fd.get('ceiling')||'pb',
    door: fd.get('door')||'wood_solid',
    doorSeal: fd.get('doorSeal')||'gasket',
    glazing: fd.get('glazing')||'single',
    features: getAllChecked('feature'),
    // 効果・制約
    effects: getAllChecked('effect'),
    work: fd.get('work')||'night',
    zeroLeak: fd.get('zeroLeak')==='yes',
    selfScore: Number(fd.get('selfScore')||5)
  };
}

// ===============================================
// 物性（吸音率）／幾何ヘルパ
// ===============================================
const alpha = {
  // 壁
  gypsum:{a500:0.06, a1000:0.06},
  rc:{a500:0.02, a1000:0.02},
  glass_s:{a500:0.15, a1000:0.10},
  glass_d:{a500:0.12, a1000:0.10},
  abs_finish:{a500:0.30, a1000:0.30},
  wood:{a500:0.10, a1000:0.08},
  steel_part:{a500:0.07, a1000:0.06},
  unknown:{a500:0.06, a1000:0.06},
  // 床
  carpet:{a500:0.21, a1000:0.26},
  wood_f:{a500:0.10, a1000:0.08},
  pvc:{a500:0.02, a1000:0.02},
  tile_stone:{a500:0.02, a1000:0.02},
  floor_unknown:{a500:0.10, a1000:0.08},
  // 天井（実効寄与抑制）
  pb:{a500:0.10, a1000:0.08},
  mineral_grid:{a500:0.45, a1000:0.55},
  metal:{a500:0.10, a1000:0.10},
  exposed:{a500:0.05, a1000:0.05},
  ceil_unknown:{a500:0.10, a1000:0.08}
};
function getAlphaWall(k){ return alpha[k] || alpha.gypsum; }
function getAlphaFloor(k){
  if(k==='carpet') return alpha.carpet;
  if(k==='wood') return alpha.wood_f;
  if(k==='pvc') return alpha.pvc;
  if(k==='tile_stone') return alpha.tile_stone;
  return alpha.floor_unknown;
}
function getAlphaCeil(k){ return alpha[k] || alpha.ceil_unknown; }

function heightFromKey(k){
  if(k==='lt2_5') return 2.4;
  if(k==='2_5_3_0') return 2.75;
  if(k==='3_0_3_5') return 3.25;
  if(k==='gt3_5') return 3.8;
  return 2.7;
}
function rtTarget(spaceType, uses){
  let t = 0.6;
  if(spaceType==='meeting_closed') t = 0.6;
  else if(spaceType==='meeting_transom') t = 0.6;
  else if(spaceType==='booth_tel' || spaceType==='booth_built') t = 0.35;
  else if(spaceType==='open' || spaceType==='callcenter') t = 0.7;
  else if(spaceType==='studio') t = 0.3;
  if(uses.includes('stream')) t *= 0.85;
  if(uses.includes('music')) t *= 0.9;
  return t;
}

// Sabine: T = 0.161 * V / Aeq（天井寄与抑制＆キャップ）
function calcRT(d){
  const A = Math.max(0.1, d.area);
  const H = heightFromKey(d.ceilHeight);
  const V = A * H;
  const s = Math.sqrt(A);
  const wallAreas = [s*H, s*H, s*H, s*H];
  const floorArea = A;
  const ceilArea  = A;

  const aw = d.walls.map(w=> getAlphaWall(w));
  const af = getAlphaFloor(d.floor);
  const ac = getAlphaCeil(d.ceiling);

  const walls500  = aw[0].a500*wallAreas[0] + aw[1].a500*wallAreas[1] + aw[2].a500*wallAreas[2] + aw[3].a500*wallAreas[3];
  const walls1000 = aw[0].a1000*wallAreas[0] + aw[1].a1000*wallAreas[1] + aw[2].a1000*wallAreas[2] + aw[3].a1000*wallAreas[3];
  const floor500  = af.a500 * floorArea;
  const floor1000 = af.a1000 * floorArea;

  const CEIL_EFF = 0.60;
  const Aceil500  = ac.a500  * ceilArea * CEIL_EFF;
  const Aceil1000 = ac.a1000 * ceilArea * CEIL_EFF;

  const Aflat500  = walls500  + floor500;
  const Aflat1000 = walls1000 + floor1000;

  const cap = 0.45; // 天井寄与45%まで
  const Aeq500  = Math.min(Aflat500 /(1-cap), Aflat500  + Aceil500 );
  const Aeq1000 = Math.min(Aflat1000/(1-cap), Aflat1000 + Aceil1000);

  const T500 = 0.161 * V / Math.max(0.001, Aeq500);
  const T1000 = 0.161 * V / Math.max(0.001, Aeq1000);
  return { V, A, H, s, wallAreas, floorArea, ceilArea, Aeq500, Aeq1000, T500, T1000 };
}

// ===============================================
// スコアリング（表示仕様のコメント文を新仕様に更新）
// ===============================================
function scoreAbs(d, rt){
  if (d.spaceType === 'booth_tel') return null;
  const Ttgt = rtTarget(d.spaceType, d.uses);
  const Tavg = (rt.T500 + rt.T1000)/2;
  const r = Math.max(1, Tavg / Ttgt);
  const RCAP = 1.9; // ~2倍手前で100
  const sBase = Math.min(1, Math.log(r) / Math.log(RCAP));
  let s = Math.round(100 * sBase);
  const U = new Set(d.uses);
  if (U.has('meeting_web') || U.has('meeting_hybrid') || U.has('websolo')) s += 3;
  s = Math.max(0, Math.min(100, s));
  return s;
}

function isolationIndicators(d){
  const indicators = {
    extInvasion: d.sources.includes('invasion_ext') ? 1 : 0,
    transom: d.features.includes('transom') ? 1 : 0,
    plenum: d.features.includes('shared_plenum') ? 1 : 0,
    grille: d.features.includes('grille') ? 1 : 0,
    gaps: ['gap_door_bottom','gap_frame','gap_penetration','gap_duct']
            .some(k=>d.features.includes(k)) ? 1 : 0
  };
  const any = Object.values(indicators).some(v=>v===1);
  return {indicators, any};
}
function wallStatsForIsl(walls){
  const cnt = t => walls.filter(w=>t.includes(w)).length;
  return { glassCount: cnt(['glass_s','glass_d']), rcCount: cnt(['rc']) };
}
function scoreIsl(d, rt){
  if (d.spaceType === 'booth_tel') return null;
  let s = 0;
  const {indicators, any} = isolationIndicators(d);
  const ws = wallStatsForIsl(d.walls);
  if (indicators.transom) s += 28;
  if (indicators.plenum) s += 28;
  if (indicators.grille) s += 22;
  if (indicators.gaps)   s += 12;
  if (indicators.extInvasion) s += 24;
  if (d.door === 'wood_honeycomb') s += 12;
  if (d.door === 'glass_s' || d.door === 'glass_d') s += 10;
  if (d.door === 'steel') s -= 8;
  if (d.doorSeal === 'gap') s += 10;
  if (d.doorSeal === 'gasket') s -= 5;
  if (d.glazing === 'single') s += 8;
  if (d.glazing === 'double') s -= 6;
  if (ws.glassCount >= 2) s += 8;
  else if (ws.glassCount === 1) s += 5;
  if (ws.rcCount >= 2) s -= 8;
  const privacyUse = ['exec','external'];
  if (privacyUse.some(u=>d.uses.includes(u))) s += any ? 6 : 3;
  if (!any) s = Math.min(s, 35);
  const Ttgt = rtTarget(d.spaceType, d.uses);
  const Tavg = (rt.T500 + rt.T1000) / 2;
  const ratio = Tavg / Ttgt;
  if (ratio >= 1.5 && s < 40) s *= 0.6;
  else if (ratio >= 1.3 && s < 50) s *= 0.7;
  return Math.max(0, Math.round(s));
}

// ===============================================
// iwasemi 枚数・見積（仕様 F）
// ===============================================
const PANEL_ANCHORS = [
  {a:  5, p:  50},
  {a: 10, p: 100},
  {a: 15, p: 150},
  {a: 20, p: 190},
  {a: 25, p: 230},
  {a: 30, p: 270},
  {a: 40, p: 350},
  {a: 50, p: 430},
  {a: 60, p: 500},
  {a: 80, p: 640},
  {a:100, p: 770}
];
function interpPanels(area){
  if (area <= PANEL_ANCHORS[0].a) return PANEL_ANCHORS[0].p;
  for (let i=1;i<PANEL_ANCHORS.length;i++){
    const lo = PANEL_ANCHORS[i-1], hi = PANEL_ANCHORS[i];
    if (area <= hi.a){
      const t = (area - lo.a)/(hi.a - lo.a);
      const p = lo.p + t*(hi.p - lo.p);
      return Math.round(p);
    }
  }
  const last = PANEL_ANCHORS[PANEL_ANCHORS.length-1];
  const prev = PANEL_ANCHORS[PANEL_ANCHORS.length-2];
  const slope = (last.p - prev.p) / (last.a - prev.a);
  const extra = (area - last.a) * slope;
  return Math.round(last.p + extra);
}
function iwasemiPanelsTotal(areaPerRoom, rooms){
  const perRoom = Math.max(1, interpPanels(Math.max(1, areaPerRoom)));
  return perRoom * Math.max(1, Math.round(rooms||1));
}

// 見積（製品単価 5,000円/枚、隙詰め 15,000円/室、設置費=20%）
const UNIT_PRICE = 5000;
function buildPanelSolutions(d, primaryKey, rt){
  const perRoomStd = Math.max(1, interpPanels(d.area));
  const totalStd = perRoomStd * Math.max(1, Math.round(d.rooms));
  const totalPro = Math.max(totalStd+1, Math.round(totalStd * 1.2)); // 強め=+20%

  function bomFor(panels, withSeal){
    const parts = [];
    const pricePanels = panels * UNIT_PRICE;
    parts.push({name:'iwasemi パネル（代表）', qty: panels, price: pricePanels});
    let extras = 0;
    if (withSeal){
      const rooms = Math.max(1, Math.round(d.rooms));
      const seal = 15000 * rooms;
      parts.push({name:'隙詰めセット（ドア/枠・部屋数相当）', qty: rooms, price: seal});
      extras += seal;
    }
    const install = Math.round(pricePanels * 0.20);
    parts.push({name:'仮設・夜間施工（概算）', qty: 1, price: install});
    const subtotal = pricePanels + extras + install;
    return { bom:parts, subtotal };
  }

  const needSeal = (primaryKey==='abs_plus_seal' || primaryKey==='isolation');
  const std = bomFor(totalStd, needSeal);
  const pro = bomFor(totalPro, needSeal);
  return {
    perRoomStd, totalStd, totalPro,
    plans:[
      {name:'標準', panels: totalStd, bom: std.bom, subtotal: std.subtotal},
      {name:'強め', panels: totalPro, bom: pro.bom, subtotal: pro.subtotal}
    ]
  };
}

// ===============================================
// 表示（仕様に合わせた文面）
// ===============================================

// サマリ指標の説明文（新仕様）
function explainAbsText(s, spaceType){
  if (spaceType === 'booth_tel') {
    return 'ブースは残響音よりも、使用面材や構造の影響を大きく受けます。診断数値は参考値としてご確認ください。';
  }
  if (s <= 19)   return '音の響きは少なく、今のままでも快適な環境です。反響の問題は小さく、特に追加対策は不要と思われます。';
  if (s <= 59)   return '声が少し響き、オンライン会議などで聞き取りづらさが出ることがあります。壁や天井に吸音材を加えると改善します。';
  return '反響が強く、会議や商談のコミュニケーションに支障が出る恐れがあります。壁やガラス面への吸音パネル追加を推奨します。';
}
function explainIslText(s, spaceType){
  if (spaceType === 'booth_tel') {
    return 'ブースの漏れ・遮音は製品固有要素に依存します。現場確認を推奨します。';
  }
  if (s <= 19)   return '遮音性能は十分で、大きな音漏れの懸念は少ないです。';
  if (s <= 59)   return '隣室や廊下への音漏れが発生しやすい構造です。ドアや壁の隙間対策で改善が期待できます。';
  return '音漏れのリスクが高く、建具の気密対策や遮音工事の検討が強く推奨されます。';
}

// 近い導入事例（通常）
const CASES = [
  {id:'knox',        title:'KNOXデモルーム',                                url:'https://iwasemi.com/posts/acoustic-solution-knox-demo-room', img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1588_v-frms_webp_3cbe404c-75d6-4e03-a62a-ccb5d4e1bf2a.jpg', tags:['meeting','absorption']},
  {id:'onosokki',    title:'小野測器（会議室）',                            url:'https://iwasemi.com/posts/onosokki-acousticpanel',           img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2388x1321_v-frms_webp_c232231e-3823-470b-9090-e72e25eb6e1c.png', tags:['meeting','absorption']},
  {id:'maruni',      title:'マルニコーポレーション',                        url:'https://iwasemi.com/posts/maruni-acousticpanel',             img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-934x649_v-fs_webp_95193a5e-061a-4636-8c33-235b921e0e61.jpg', tags:['meeting','absorption']},
  {id:'aston',       title:'アストン',                                       url:'https://iwasemi.com/posts/aston-iwasemi',                     img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1600_v-frms_webp_9ebd7a93-0b96-4f2e-a7af-45ebeb6a0738.jpg', tags:['meeting','absorption']},
  {id:'tokyo-bldg',  title:'東京建物（オープン）',                           url:'https://iwasemi.com/posts/tokyo-building-acoustic-solution',  img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_89d08d5f-9ad3-42aa-a86f-d5eda6b37341.jpg', tags:['open','absorption']},
  {id:'yanmar',      title:'ヤンマーHD',                                     url:'https://iwasemi.com/posts/yanmar-acousticpanel',              img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_27fb2553-22a6-4a7f-be6e-d28fe418a633.jpg', tags:['meeting','absorption']},
  {id:'panasonic',   title:'パナソニックE&C',                                url:'https://iwasemi.com/posts/panasonic-iwasemi',                 img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1600_v-frms_webp_00ebe96d-5f99-4eb6-b787-25acb33066b0.jpg', tags:['open','absorption']},
  {id:'toyota-conn', title:'トヨタコネクテッド',                              url:'https://iwasemi.com/posts/toyota-connected-acoustic-solution',img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1600_v-frms_webp_e0ce5f6f-f1d2-4ae4-ada9-bae2514f1fab.jpg', tags:['meeting','open','absorption']},
  {id:'mext',        title:'文部科学省',                                      url:'https://iwasemi.com/posts/mext-iwasemi-case-study',           img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_9fdc4207-ca78-475d-890e-5ca0e4d34d08.jpg', tags:['meeting','absorption']},
  {id:'nw-life',     title:'ニッセイ・ウェルス生命',                         url:'https://iwasemi.com/posts/nw-life-iwasemi',                   img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_f34ed0a6-e0aa-468b-80bf-c327b8764cdf.jpg', tags:['open','absorption']},
  {id:'mlit',        title:'国土交通省（遮音強化事例）',                      url:'https://iwasemi.com/posts/MLIT-iwasemi',                      img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-5464x8192_v-frms_webp_6b248fdc-adb9-4ff7-8bff-0dc90638c33f.jpg', tags:['isolation','meeting']},
  {id:'hokkoku',     title:'北国銀行',                                        url:'https://iwasemi.com/posts/HokkokuBank',                       img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-2400x1601_v-frms_webp_595a7dc4-088c-4a60-b2f8-2ca3cdaadf83.jpg', tags:['meeting','absorption']},
  {id:'toyota-ej',   title:'トヨタ自動車東日本',                              url:'https://iwasemi.com/posts/toyota-ej-iwasemi',                 img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-6000x3376_v-frms_webp_a5df4af2-716a-4899-baf4-2584b996f190.jpg', tags:['meeting','absorption']},
  {id:'comado',      title:'Maison Comado（スタジオ）',                       url:'https://iwasemi.com/posts/cWx2W1kL',                           img:'https://storage.googleapis.com/studio-cms-assets/projects/JpOLNkebaQ/s-4032x3024_v-frms_webp_78f5fa8f-2eba-49a6-8074-41ffab353fa2.jpg', tags:['studio','absorption']},
  {id:'coincheck',   title:'コインチェック（オープン）',                      url:'https://iwasemi.com/posts/coincheck-iwasemi',                 img:'https://storage.googleapis.com/studio-design-asset-files/projects/JpOLNkebaQ/s-2400x621_v-frms_webp_7d402690-6c30-46e1-96ce-ae19f2480ef5_small.webp', tags:['open','absorption']}
];

function pickCases(d, S, primaryKey){
  const want = new Set();
  if (primaryKey==='isolation' || ['transom','shared_plenum','grille'].some(f=>d.features.includes(f))) want.add('isolation');
  if (d.spaceType==='open' || d.spaceType==='callcenter') want.add('open');
  if (d.spaceType==='studio') want.add('studio');
  if (d.spaceType.startsWith('meeting')) want.add('meeting');
  if (S.S_abs===null || S.S_abs>=12) want.add('absorption');
  const ranked = CASES.slice().sort((a,b)=>{
    const scoreTag = (obj)=> {
      let s=0;
      if (want.has('isolation') && obj.tags.includes('isolation')) s+=3;
      if (want.has('meeting') && obj.tags.includes('meeting')) s+=2;
      if (want.has('open') && obj.tags.includes('open')) s+=2;
      if (want.has('studio') && obj.tags.includes('studio')) s+=2;
      if (want.has('absorption') && obj.tags.includes('absorption')) s+=1;
      return s;
    };
    return scoreTag(b)-scoreTag(a);
  });
  const uniq=[]; const used=new Set();
  for(const c of ranked){ if(!used.has(c.id)){ uniq.push(c); used.add(c.id);} if(uniq.length>=3) break; }
  return uniq;
}
function renderCases(cases){
  const el = $('#caseWrap');
  if (!el) return;
  if (!cases || !cases.length){ el.innerHTML=''; return; }
  el.classList.remove('hidden');
  el.innerHTML = `
    <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
      <div class="text-lg font-semibold mb-2">近い導入事例</div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        ${cases.map(c=>`
          <a class="block p-3 rounded-xl bg-slate-50 dark:bg-slate-900/40 border border-slate-200 dark:border-slate-700 hover:border-emerald-400 transition"
             href="${c.url}" target="_blank" rel="noopener">
            <img class="case-img" referrerpolicy="no-referrer" loading="lazy"
                 src="${c.img}" alt="${c.title}"
                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22240%22><rect width=%22400%22 height=%22240%22 fill=%230b1220/><text x=%2220%22 y=%22130%22 fill=%23ffffff>画像を取得できません</text></svg>';">
            <div class="mt-2 text-sm font-medium">${c.title}</div>
          </a>
        `).join('')}
      </div>
    </div>`;
}

// === テレキューブ専用：事例写真の固定表示 ===
// 画像ファイル telecube_iwasemi.png を本HTMLと同じフォルダに配置してください。
function renderBoothCase() {
  const wrap = $('#boothCaseWrap');
  if (!wrap) return;
  wrap.classList.remove('hidden');
  wrap.innerHTML = `
    <div class="p-4 md:p-5 rounded-2xl border border-slate-200 dark:border-slate-700">
      <div class="text-lg font-semibold mb-2">テレキューブ導入事例</div>
      <img
        src="telecube_iwasemi.png"
        alt="TELECUBE × iwasemi 導入事例"
        class="w-full rounded-xl shadow-sm"
        loading="lazy"
        referrerpolicy="no-referrer"
        onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22720%22 height=%22400%22><rect width=%22720%22 height=%22400%22 fill=%230b1220/><text x=%2220%22 y=%22220%22 font-size=%2220%22 fill=%23ffffff>画像を取得できません</text></svg>';"
      />
      <p class="text-sm mt-2 text-slate-600 dark:text-slate-300">
        TELECUBEにiwasemi RC-αを導入した事例写真です。片面／両面ガラスの構成に応じて、適切な枚数を設置することで
        快適な音環境とほどよい目隠し効果を両立します。
      </p>
    </div>
  `;
}

// ===============================================
// RENDER：画面各セクション
// ===============================================
function clearResult(){
  $('#proposalSummary').innerHTML = '';
  $('#globalCtas').innerHTML = '';
  $('#evidenceWrap').innerHTML = '';
  $('#caseWrap').innerHTML = '';
  $('#recommendWrap').innerHTML = '';
  $('#iwasemiWrap').innerHTML = '';
  $('#notesWrap').innerHTML = '';
  const b = $('#boothCaseWrap');
  if (b){ b.innerHTML = ''; b.classList.add('hidden'); }
}

const TRIAL_URL = 'https://iwasemi.com/form';
const MEET_URL  = 'https://pixiedusttech.eeasy.jp/sakiho-shiraiwa/general?1740439824640';
const CONTACT_URL = 'https://iwasemi.com/form';

function renderGlobalCTAs(){
  $('#globalCtas').classList.remove('hidden');
  $('#globalCtas').innerHTML = `
    <div class="flex flex-wrap gap-2">
      <a href="${TRIAL_URL}" target="_blank" rel="noopener" class="px-3 py-2 rounded-xl bg-emerald-600 text-white text-sm">トライアルを申し込む</a>
      <a href="${MEET_URL}"  target="_blank" rel="noopener" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm dark:bg-slate-100 dark:text-slate-900">担当者と打ち合わせ</a>
      <a href="${CONTACT_URL}" target="_blank" rel="noopener" class="px-3 py-2 rounded-xl border border-slate-300 dark:border-slate-700 text-sm">お問い合わせ</a>
    </div>`;
}

function renderProposalSummary(d, recs, S, rt, panelSol){
  const top = recs[0];
  let priceLine = `<span class="badge bg-white/60 dark:bg-slate-800/60">別途見積</span>`;
  if (top && (top.key==='absorption' || top.key==='abs_plus_seal')){
    const std = panelSol.plans.find(p=>p.name==='標準')?.subtotal||0;
    const pro = panelSol.plans.find(p=>p.name==='強め')?.subtotal||0;
    priceLine = `<span class="tabular-nums font-semibold">${yen(std)}〜${yen(pro)}</span> <span class="text-xs text-slate-500">（概算・税抜）</span>`;
  }
  const ctas = [
    top?.key==='absorption' ? {label:'トライアルを申し込む',href:TRIAL_URL} : null,
    top?.key==='abs_plus_seal' ? {label:'隙詰め同時で相談（PxDT）',href:CONTACT_URL} : null,
    top?.key==='isolation' ? {label:'担当者と打ち合わせ',href:MEET_URL} : null
  ].filter(Boolean);

  $('#proposalSummary').innerHTML = `
    <div class="p-4 md:p-5 rounded-2xl border border-emerald-300/50 bg-emerald-50/60 dark:bg-emerald-900/20 dark:border-emerald-700">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <div>
          <div class="text-sm text-emerald-900/80 dark:text-emerald-100/80">今回のご提案（結論）</div>
          <div class="mt-1 text-xl font-semibold">解決カテゴリ：${top?top.label:'計測/トライアル'} ${top?`<span class="badge">${top.priority}</span>`:''}</div>
          <p class="text-sm mt-1 text-emerald-900/85 dark:text-emerald-100/85">${top?top.reason:'境界条件のため、残響測定または体感トライアルで効果を事前検証します。'}</p>
        </div>
        <div class="text-right">
          <div class="text-xs text-slate-500">概算見積</div>
          <div class="text-lg">${priceLine}</div>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        ${ctas.map(c=>`<a href="${c.href}" target="_blank" rel="noopener" class="px-3 py-2 rounded-xl bg-slate-900 text-white text-sm dark:bg-slate-100 dark:text-slate-900">${c.label}</a>`).join('')}
      </div>
    </div>`;
}

function evidenceLines(d, S, rt){
  const Ttgt = rtTarget(d.spaceType, d.uses);
  const Tavg = (rt.T500 + rt.T1000)/2;
  const ratio = Tavg / Ttgt;
  const feats = [];
  if (d.features.includes('transom')) feats.push('欄間オープン');
  if (d.features.includes('shared_plenum')) feats.push('共有天井裏');
  if (d.features.includes('grille')) feats.push('ガラリ/換気開口');
  if (['gap_door_bottom','gap_frame','gap_penetration','gap_duct'].some(x=>d.features.includes(x))) feats.push('隙間あり');
  if (d.sources.includes('invasion_ext')) feats.push('外部からの音の侵入');

  // 残響評価文（仕様C-2）
  let explainRT = '';
  if (ratio >= 1.3) explainRT = '残響時間が目標より長い状態です。吸音対策の導入が効果的です。';
  else if (ratio <= 0.9) explainRT = '残響は良好な範囲です。';
  else explainRT = '音の響きはおおむね適正範囲です。必要に応じて軽微な吸音対策で調整できます。';

  // 回り込み評価文（仕様C-2）
  let explainLeak = '';
  if (S.S_isl>=45) explainLeak = '音が隣に回り込みやすい状態です。壁やドアのすき間、上部の開口部などから漏れている可能性があります。隙間パッキンや遮音パネルの追加を検討ください。';
  else if (S.S_isl>=30) explainLeak = '音の回り込みが軽微にある可能性があります。箇所を特定し、簡易対策の検討をおすすめします。';
  else explainLeak = '音の回り込み要素は小さく、遮音性は良好です。';

  return {
    line1: `残響：平均 ${fmt2(Tavg)}s / 目標 ${fmt2(Ttgt)}s（比 ${fmt2(ratio)}）`,
    line2: `吸音必要度 ${S.S_abs===null?'—':S.S_abs} / 遮音必要度 ${S.S_isl===null?'—':S.S_isl}（0〜100）`,
    line3: `回り込みの要因：${feats.length?feats.join('・'):'特になし'}`,
    explainRT, explainLeak
  };
}

function renderEvidence(d, S, rt){
  const isBooth = d.spaceType==='booth_tel';
  if (isBooth){
    $('#evidenceWrap').innerHTML = `
      <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
        <div class="text-sm font-semibold">吸音必要度</div>
        <div class="text-2xl font-bold">—</div>
        <div class="text-xs text-slate-500 mt-1">ブースは製品仕様の影響が大きいため参考値としてご確認ください。</div>
      </div>
      <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
        <div class="text-sm font-semibold">遮音必要度</div>
        <div class="text-2xl font-bold">—</div>
        <div class="text-xs text-slate-500 mt-1">ブースの漏れ・遮音は製品固有要素に依存します。現場確認を推奨します。</div>
      </div>
      <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
        <div class="text-sm text-slate-500 mb-1">残響・目標</div>
        <div class="text-sm">残響：平均 — / 目標 —（ブースは製品仕様依存）</div>
        <div class="text-xs mt-2">※個別最適化をご提案します。</div>
      </div>`;
    return;
  }

  const L = evidenceLines(d,S,rt);
  $('#evidenceWrap').innerHTML = `
    <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
      <div class="text-sm font-semibold">吸音必要度</div>
      <div class="text-2xl font-bold">${S.S_abs===null?'—':S.S_abs} / 100</div>
      <div class="text-xs text-slate-500 mt-1">${explainAbsText(S.S_abs, d.spaceType)}</div>
    </div>
    <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
      <div class="text-sm font-semibold">遮音必要度</div>
      <div class="text-2xl font-bold">${S.S_isl===null?'—':S.S_isl} / 100</div>
      <div class="text-xs text-slate-500 mt-1">${explainIslText(S.S_isl, d.spaceType)}</div>
    </div>
    <div class="p-4 rounded-xl bg-slate-50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700">
      <div class="text-sm text-slate-500 mb-1">残響・目標</div>
      <div class="text-sm">${L.line1}</div>
      <div class="text-xs text-slate-500 mt-2">500Hz=${fmt2(rt.T500)}s（Aeq=${fmt2(rt.Aeq500)}m²） / 1000Hz=${fmt2(rt.T1000)}s（Aeq=${fmt2(rt.Aeq1000)}m²）</div>
      <div class="text-xs mt-2">${L.explainRT}</div>
      <div class="mt-3 text-sm">${L.line3}</div>
      <div class="text-xs mt-2">${L.explainLeak}</div>
    </div>`;
}

// ===============================================
// Googleフォーム送信関連（ENTRY_MAP は最新）
// ===============================================
const GF_FORM_ID = '1FAIpQLSf8Eo_j14pXA3mTRSt5tN_gQ0Py46cV-8Rd1ZBW7Nt9cltIpQ';
const GF_ENDPOINT = `https://docs.google.com/forms/d/e/${GF_FORM_ID}/formResponse`;

// ★最新の割当（ユーザー提示URL順ベース）
// 既存：company/person/email は本仕様では person/email 未使用だが互換のため空で送る
const ENTRY_MAP = {
  company:'entry.633735891',
  person:'entry.1897466872',      // 互換：空送信
  email:'entry.520438276',        // 互換：空送信
  pref:'entry.1016772262',
  project:'entry.1643209832',
  category:'entry.1456767678',
  spaceType:'entry.875012016',
  uses:'entry.829570765',
  sources:'entry.1840420677',
  area:'entry.1193986863',
  rooms:'entry.1894381184',
  ceilHeight:'entry.237126416',
  wall1:'entry.713604363',
  wall2:'entry.1601335444',
  wall3:'entry.803869896',
  wall4:'entry.784934428',
  floor:'entry.402764184',
  ceiling:'entry.665830996',
  door:'entry.67943677',
  doorSeal:'entry.901692185',
  glazing:'entry.1003016767',
  features:'entry.685782864',

  // 追加（顧客情報）
  industry:'entry.863972',
  size:'entry.743322677',
  pref2:'entry.335161338',        // フォームに都道府県が重複しているため、pref2にも同値を送る
  timeline:'entry.1013219285',

  effects:'entry.127489878',
  zeroLeak:'entry.363506085',
  selfScore:'entry.1025555385',
  S_abs:'entry.2144586639',
  S_isl:'entry.23030069',
  primaryKey:'entry.902891300',
  topLabel:'entry.892698191',
  topReason:'entry.447335823',
  panels_std:'entry.1375581996',
  panels_pro:'entry.267227546',
  price_std:'entry.1883756001',
  price_pro:'entry.382111843',
  raw_json:'entry.1555376589',

  // 追加（代理店担当者情報）
  agent_company:'entry.1294566503',
  agent_person:'entry.2017082841',
  agent_email:'entry.1181916971'
};

function buildGoogleFormPayload(diag){
  const d = diag.input, S = diag.scores, rt = diag.rt, recs = diag.recommendations, panels = diag.panels;
  const top = recs[0] || {key:'measure', label:'計測/トライアル', reason:'', score:0};
  return {
    // 顧客情報
    company: d.company,
    person: '',                 // 互換のため空
    email:  '',                 // 互換のため空
    pref: d.pref,
    project: d.project, category: d.category, spaceType: d.spaceType,
    uses: d.uses.join(','), sources: d.sources.join(','),
    area: d.area, rooms: d.rooms, ceilHeight: d.ceilHeight,
    wall1: d.walls[0], wall2: d.walls[1], wall3: d.walls[2], wall4: d.walls[3],
    floor: d.floor, ceiling: d.ceiling, door: d.door, doorSeal: d.doorSeal, glazing: d.glazing,
    features: d.features.join(','), effects: d.effects.join(','), zeroLeak: d.zeroLeak? 'yes':'no',
    selfScore: d.selfScore,
    // 追加分
    industry: d.industry, size: d.size, pref2: d.pref, timeline: d.timeline,

    // スコア・提案
    S_abs: (S.S_abs==null?'NA':S.S_abs),
    S_isl: (S.S_isl==null?'NA':S.S_isl),
    primaryKey: top.key, topLabel: top.label, topReason: top.reason,

    // パネル見積
    panels_std: panels.plans.find(p=>p.name==='標準')?.panels || 0,
    panels_pro: panels.plans.find(p=>p.name==='強め')?.panels || 0,
    price_std: panels.plans.find(p=>p.name==='標準')?.subtotal || 0,
    price_pro: panels.plans.find(p=>p.name==='強め')?.subtotal || 0,

    // 代理店担当者
    agent_company: d.agent_company,
    agent_person: d.agent_person,
    agent_email: d.agent_email,

    // 生データ
    raw_json: JSON.stringify(diag)
  };
}

async function postToGoogleForm(payload){
  const norm = (v) => Array.isArray(v) ? v.join(',') : (typeof v==='boolean' ? (v?'yes':'no') : (v??''));
  const params = new URLSearchParams();
  for (const [k, entryId] of Object.entries(ENTRY_MAP)) {
    if (k in payload) params.append(entryId, norm(payload[k]));
  }
  try{
    await fetch(GF_ENDPOINT, {
      method:'POST',
      mode:'no-cors',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8' },
      body: params.toString()
    });
    return { ok:true, mode:'no-cors' };
  }catch(e){
    try{
      const blob = new Blob([params.toString()], {type:'application/x-www-form-urlencoded;charset=UTF-8'});
      if (navigator.sendBeacon(GF_ENDPOINT, blob)) return { ok:true, mode:'beacon' };
    }catch(_){}
    return { ok:false };
  }
}

// ===============================================
// TELECUBE 固定レコメンド
// ===============================================
function recommendForBoothTel(d){
  return [
    { key:'absorption', label:'吸音（ブース内面）', priority:'高', score:50,
      reason:'ブースは容積が小さく反射面の比率が高いため、話し声のこもり・高域反射が生じやすいです。ガラス面や正対壁へ薄型パネルを推奨します。',
      cta:{label:'トライアルを申し込む',kind:'trial'} },
    { key:'abs_plus_seal', label:'隙詰め（ブースの気密ケア）', priority:'中', score:40,
      reason:'ドア下・枠まわり・貫通部の簡易封止により外部への漏れ・外部からの侵入を低減します。',
      cta:{label:'隙詰め同時で相談（PxDT）',kind:'pxdt'} }
  ];
}
</script>

  <script>
// === ユーティリティ ===
const $ = (sel) => document.querySelector(sel);
const $$ = (sel) => document.querySelectorAll(sel);

// トースト表示
function toast(msg, ok=true){
  const t = $('#toast');
  t.textContent = msg;
  t.classList.remove('hidden');
  t.classList.toggle('bg-green-600', ok);
  t.classList.toggle('bg-red-600', !ok);
  setTimeout(()=>t.classList.add('hidden'), 3000);
}

// === Googleフォーム連携 ===
const FORM_URL = "https://docs.google.com/forms/d/e/1FAIpQLSf8Eo_j14pXA3mTRSt5tN_gQ0Py46cV-8Rd1ZBW7Nt9cltIpQ/formResponse";

const ENTRY_MAP = {
  company: "entry.633735891",
  person: "entry.1897466872",
  email: "entry.520438276",
  pref: "entry.1016772262",
  project: "entry.1643209832",
  category: "entry.1456767678",
  spaceType: "entry.875012016",
  uses: "entry.829570765",
  sources: "entry.1840420677",
  area: "entry.1193986863",
  rooms: "entry.1894381184",
  ceilHeight: "entry.237126416",
  wall1: "entry.713604363",
  wall2: "entry.1601335444",
  wall3: "entry.803869896",
  wall4: "entry.784934428",
  floor: "entry.402764184",
  ceiling: "entry.665830996",
  door: "entry.67943677",
  doorSeal: "entry.901692185",
  glazing: "entry.1003016767",
  features: "entry.685782864",
  industry: "entry.863972",
  size: "entry.743322677",
  pref2: "entry.335161338",
  timeline: "entry.1013219285",
  effects: "entry.127489878",
  zeroLeak: "entry.363506085",
  selfScore: "entry.1025555385",
  S_abs: "entry.2144586639",
  S_isl: "entry.23030069",
  primaryKey: "entry.902891300",
  topLabel: "entry.892698191",
  topReason: "entry.447335823",
  panels_std: "entry.1375581996",
  panels_pro: "entry.267227546",
  price_std: "entry.1883756001",
  price_pro: "entry.382111843",
  raw_json: "entry.1555376589",
  agent_company: "entry.1294566503",
  agent_person: "entry.2017082841",
  agent_email: "entry.1181916971",
};

async function postToGoogleForm(payload){
  const params = new URLSearchParams(payload);
  try {
    const res = await fetch(FORM_URL, { method: 'POST', mode: 'no-cors', body: params });
    return {ok:true};
  } catch(e){
    console.error(e);
    return {ok:false};
  }
}

function buildGoogleFormPayload(diag){
  const d = diag.input;
  const payload = {};
  for (const k in ENTRY_MAP){
    if (d[k]!==undefined) payload[ENTRY_MAP[k]] = d[k];
  }
  // スコア類
  if (diag.scores){
    payload[ENTRY_MAP.S_abs] = diag.scores.S_abs ?? 'NA';
    payload[ENTRY_MAP.S_isl] = diag.scores.S_isl ?? 'NA';
  }
  payload[ENTRY_MAP.primaryKey] = diag.recommendations[0]?.key || '';
  payload[ENTRY_MAP.topLabel] = diag.recommendations[0]?.label || '';
  payload[ENTRY_MAP.topReason] = diag.recommendations[0]?.reason || '';
  payload[ENTRY_MAP.raw_json] = JSON.stringify(diag);
  return payload;
}

// === スコア算出（吸音/遮音） ===
function scoreAbs(d, rt){
  if (!rt || !rt.T500 || !rt.T1000) return null;
  const Tavg = (rt.T500+rt.T1000)/2;
  const Ttarget = rtTarget(d);
  const r = Tavg/Ttarget;
  if (r < 1) return 0;
  const RCAP=1.9;
  return Math.round(100*Math.min(1, Math.log(r)/Math.log(RCAP)));
}
function scoreIsl(d, rt){
  let score=0;
  if (d.features?.includes('transom')) score+=28;
  if (d.features?.includes('shared_plenum')) score+=28;
  if (d.features?.includes('grille')) score+=22;
  if (d.door==='honeycomb') score+=12;
  if (d.door==='glass') score+=10;
  if (d.door==='steel') score-=8;
  if (d.doorSeal==='gap') score+=10;
  if (d.doorSeal==='gasket') score-=5;
  if (d.glazing==='1') score+=5;
  if (d.glazing==='2') score+=8;
  return Math.max(0,Math.min(100,score));
}
function rtTarget(d){
  // 固定で0.6sを目標とする
  return 0.6;
}

// === CLEAR ===
function clearResult(){
  $('#proposalSummary').innerHTML='';
  $('#globalCtas').innerHTML='';
  $('#evidenceWrap').innerHTML='';
  $('#caseWrap').innerHTML='';
  $('#recommendWrap').innerHTML='';
  $('#estimateWrap').innerHTML='';
  $('#notesWrap').innerHTML='';
  const b=$('#boothCaseWrap'); if (b){ b.innerHTML=''; b.classList.add('hidden'); }
}

// === レンダリング（省略詳細、パート1/2に含まれるUI関数を利用） ===
// renderProposalSummary, renderGlobalCTAs, renderEvidence, renderCases, renderRecommendations,
// renderIwasemiDetail, renderNotes, renderBoothCase が定義済み前提

// === DIAGNOSE ===
async function diagnose(){
  const d = {
    company: $('#company').value,
    person: $('#person').value,
    email: $('#email').value,
    pref: $('#pref').value,
    project: $('#project').value,
    category: $('#category').value,
    spaceType: $('#spaceType').value,
    uses: $('#uses').value,
    sources: $('#sources').value,
    area: parseFloat($('#area').value||0),
    rooms: parseInt($('#rooms').value||1),
    ceilHeight: $('#ceilHeight').value,
    features: ($('#features').value||'').split(',').map(s=>s.trim()).filter(Boolean),
    agent_company: $('#agent_company')?.value||'',
    agent_person: $('#agent_person')?.value||'',
    agent_email: $('#agent_email')?.value||''
  };

  const V = d.area * (parseFloat(d.ceilHeight)||2.7);
  if (V>250){
    clearResult();
    $('#proposalSummary').innerHTML = `<div class="p-4 border rounded-xl">
      <h3 class="font-bold text-lg mb-2">このツールの対象外です（大容積）</h3>
      <p>ホールなどの広い空間では、部屋の大きさに合わせた音の響き（残響時間）の目標を設定する必要があります。最適な対策を行うために、測定や設計の検討が必要です。詳しくはご相談ください。</p>
    </div>`;
    renderGlobalCTAs();
    return;
  }

  // --- TELECUBE 特例 ---
  if (d.spaceType==='booth_tel'){
    const recs=[{key:'absorption',label:'吸音',reason:'ブース内部の響きを改善'},
                {key:'abs_plus_seal',label:'吸音＋隙詰め',reason:'気密性改善'}];
    clearResult();
    renderProposalSummary(d,recs,{S_abs:null,S_isl:null},{},[]);
    renderGlobalCTAs();
    renderEvidence(d,{S_abs:null,S_isl:null},{});
    // 事例 → テレキューブ専用
    renderBoothCase();
    renderRecommendations(recs,[],recs[0].key);
    renderIwasemiDetail(d,[],recs[0].key);
    renderNotes(recs[0].key);
    const diag={input:d,scores:{S_abs:'NA',S_isl:'NA'},recommendations:recs};
    const payload=buildGoogleFormPayload(diag);
    await postToGoogleForm(payload);
    toast('診断が完了しました');
    return;
  }

  // --- 通常診断 ---
  const rt={T500:0.8,T1000:0.9};
  const S={S_abs:scoreAbs(d,rt), S_isl:scoreIsl(d,rt)};
  const recs=[{key:'absorption',label:'吸音',reason:'響きが長いため'}]; // 簡易
  clearResult();
  renderProposalSummary(d,recs,S,rt,[]);
  renderGlobalCTAs();
  renderEvidence(d,S,rt);
  renderCases([]); // 実際はpickCases()で
  renderRecommendations(recs,[],recs[0].key);
  renderIwasemiDetail(d,[],recs[0].key);
  renderNotes(recs[0].key);
  const diag={input:d,scores:S,rt,recommendations:recs};
  const payload=buildGoogleFormPayload(diag);
  await postToGoogleForm(payload);
  toast('診断が完了しました');
}
</script>

  
  <script>
  </script>
</body>
</html>
